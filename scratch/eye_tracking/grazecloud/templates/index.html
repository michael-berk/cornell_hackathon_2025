<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaze Tracking with Bounding Box</title>
    <script src="https://api.gazerecorder.com/GazeCloudAPI.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }

        #gazeDot {
            position: absolute;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            display: none;
            pointer-events: none;
        }

        #boundingBox {
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 255, 0.2); /* Light blue */
            border: 2px solid blue;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: background 0.2s ease;
        }

        #chart-container {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h2>Gaze Tracking with Bounding Box</h2>
    <p>Move your eyes. If your gaze enters the bounding box, it will highlight!</p>
    <button onclick="startTracking()">Start Eye Tracking</button>
    <button onclick="stopTracking()">Stop Eye Tracking</button>
    <button onclick="downloadCSV()">Download CSV</button>
    
    <div id="gazeDot"></div>
    <div id="boundingBox"></div>

    <div id="chart-container">
        <canvas id="gazeChart"></canvas>
    </div>

    <script>
        const gazeDot = document.getElementById("gazeDot");
        const boundingBox = document.getElementById("boundingBox");
        let gazeDataLog = []; 
        let gazeChart;

        function startTracking() {
            GazeCloudAPI.StartEyeTracking();
            gazeDot.style.display = "block"; 

            if (!gazeChart) {
                const ctx = document.getElementById("gazeChart").getContext("2d");
                gazeChart = new Chart(ctx, {
                    type: "scatter",
                    data: { datasets: [{ label: "Gaze Points", data: [], borderColor: "blue", backgroundColor: "rgba(0, 0, 255, 0.5)", pointRadius: 3 }] },
                    options: {
                        scales: {
                            x: { title: { display: true, text: "X Coordinate" }, min: 0, max: window.innerWidth },
                            y: { title: { display: true, text: "Y Coordinate" }, min: 0, max: window.innerHeight }
                        }
                    }
                });
            }

            GazeCloudAPI.OnResult = function (GazeData) {
                if (GazeData.state === 0) { // Valid gaze data
                    const x = Math.round(GazeData.docX);
                    const y = Math.round(GazeData.docY);
                    const timestamp = new Date().toISOString(); 

                    // Move gaze dot instantly
                    gazeDot.style.transform = `translate(${x}px, ${y}px)`;

                    // Check if gaze is inside bounding box
                    checkBoundingBox(x, y);

                    // Log data & update chart in real time
                    gazeDataLog.push({ timestamp, x, y });
                    updateChart(x, y);
                }
            };

            GazeCloudAPI.OnCalibrationComplete = function () {
                console.log("Gaze Calibration Complete!");
            };

            GazeCloudAPI.OnCamDenied = function () {
                alert("Camera access denied. Please enable your webcam.");
            };

            GazeCloudAPI.OnError = function (msg) {
                console.error("Error:", msg);
            };
        }

        function stopTracking() {
            GazeCloudAPI.StopEyeTracking();
            gazeDot.style.display = "none"; 
        }

        function updateChart(x, y) {
            if (gazeChart) {
                const dataset = gazeChart.data.datasets[0].data;
                dataset.push({ x, y });
                if (dataset.length > 100) dataset.shift();
                gazeChart.update();
            }
        }

        function checkBoundingBox(x, y) {
            const boxRect = boundingBox.getBoundingClientRect();
            if (x >= boxRect.left && x <= boxRect.right && y >= boxRect.top && y <= boxRect.bottom) {
                boundingBox.style.background = "rgba(0, 0, 255, 0.6)"; // Darker blue when gaze is inside
            } else {
                boundingBox.style.background = "rgba(0, 0, 255, 0.2)"; // Light blue when outside
            }
        }

        function downloadCSV() {
            if (gazeDataLog.length === 0) {
                alert("No gaze data recorded.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,Timestamp,X,Y\n";
            gazeDataLog.forEach(entry => {
                csvContent += `${entry.timestamp},${entry.x},${entry.y}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gaze_tracking_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
